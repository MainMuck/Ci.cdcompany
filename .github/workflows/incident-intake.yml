name: Incident Intake (alerts → tickets)

on:
  workflow_run:
    workflows: ["Security Framework Gates"]
    types: [completed]
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: read   # доступ к Dependabot alerts

jobs:
  # P1: создать инцидент, если основной security-workflow упал/истёк по времени
  open_incident_issue:
    if: >
      github.event_name == 'workflow_run' &&
      (github.event.workflow_run.conclusion == 'failure' ||
       github.event.workflow_run.conclusion == 'timed_out')
    runs-on: ubuntu-latest
    steps:
      - name: Create incident (failed Security Framework Gates)
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          GH_NO_UPDATE_NOTIFIER: "1"
          GH_PROMPT_DISABLED: "1"
        run: |
          set -euo pipefail
          TITLE="INC: Security Framework Gates failed in ${REPO}"
          BODY_FILE="$(mktemp)"
          {
            echo "# Auto-created incident"
            echo
            echo "**Workflow:** Security Framework Gates"
            echo "**Run:** ${{ github.event.workflow_run.html_url }}"
            echo "**Branch:** ${{ github.event.workflow_run.head_branch }}"
            echo
            echo "@MainMuck/oncall"
          } > "$BODY_FILE"
          gh issue create -R "$REPO" --title "$TITLE" --body-file "$BODY_FILE" --label "incident,P1"

  # P2: один «трекер»-инцидент по открытым Dependabot alert’ам
  dependabot_to_incident:
    if: github.event_name != 'workflow_run'   # по расписанию/ручному запуску
    runs-on: ubuntu-latest
    steps:
      - name: Create/refresh Dependabot incident
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          GH_NO_UPDATE_NOTIFIER: "1"
          GH_PROMPT_DISABLED: "1"
        run: |
          set -euo pipefail

          # Берём ровно число открытых алёртов. --silent + 2>/dev/null исключают
          # попадание тела ошибки в переменную при 403/404 и т.п.
          OPEN=$(gh api -R "$REPO" \
                 -H "Accept: application/vnd.github+json" \
                 "/repos/${REPO}/dependabot/alerts?state=open&per_page=100" \
                 --silent 2>/dev/null | jq 'length' 2>/dev/null || echo 0)

          if [ "${OPEN:-0}" -eq 0 ]; then
            echo "No open Dependabot alerts -> OK"
            exit 0
          fi

          TITLE="INC: Dependabot alerts open in ${REPO}"
          # Ищем уже существующий «трекер»-инцидент
          NUM=$(gh issue list -R "$REPO" --state open --search "$TITLE in:title" \
                 --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "${NUM}" ] && [ "${NUM}" != "null" ]; then
            gh issue comment -R "$REPO" "$NUM" --body "Still open: ${OPEN} alert(s)."
          else
            BODY_FILE="$(mktemp)"
            {
              echo "# Auto-created incident (Dependabot)"
              echo
              echo "Open alerts: **${OPEN}**"
              echo "See: https://github.com/${REPO}/security/dependabot"
              echo
              echo "@MainMuck/oncall"
            } > "$BODY_FILE"
            gh issue create -R "$REPO" --title "$TITLE" --body-file "$BODY_FILE" \
              --label "incident,P2,dependabot"
          fi
