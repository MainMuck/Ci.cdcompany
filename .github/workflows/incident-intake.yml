name: Incident Intake (alerts → tickets)

on:
  workflow_run:
    workflows: ["Security Framework Gates"]   # твой основной WF
    types: [completed]
  repository_vulnerability_alert:
    types: [create]                           # Dependabot alert → инцидент

permissions:
  contents: read
  issues: write                               # нужно, чтобы создать тикет

jobs:
  open_incident_issue:
    # Создаём инцидент если основной WF упал/таймаут ИЛИ пришёл vuln-алерт
    if: >
      (github.event_name == 'workflow_run' &&
       (github.event.workflow_run.conclusion == 'failure' ||
        github.event.workflow_run.conclusion == 'timed_out')) ||
      (github.event_name == 'repository_vulnerability_alert')
    runs-on: ubuntu-latest
    steps:
      - name: Create incident issue
        env:
          GH_TOKEN: ${{ github.token }}       # ОБЯЗАТЕЛЬНО для gh CLI
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TITLE="INC: Security Framework Gates failed in ${GITHUB_REPOSITORY}"
            BODY=$'# Auto-created incident\n\n'\
'**Workflow:** Security Framework Gates\n'\
'**Run:** ${{ github.event.workflow_run.html_url }}\n'\
'**Branch:** ${{ github.event.workflow_run.head_branch }}\n\n'\
'@MainMuck/oncall'
            LABELS="incident,P1"
          else
            TITLE="INC: New Dependabot alert in ${GITHUB_REPOSITORY}"
            BODY=$'# Auto-created incident (Dependabot)\n\nSee: https://github.com/'"${GITHUB_REPOSITORY}"'/security/dependabot\n\n'\
'@MainMuck/oncall'
            LABELS="incident,P2"
          fi

          gh issue create \
            --title "$TITLE" \
            --body  "$BODY" \
            --label "$LABELS"
